dist: xenial
language: rust
services: docker
sudo: required

cache: cargo
before_cache:
  - chmod -R a+r $HOME/.cargo

env:
  global:
    - CRATE_NAME=redis-hyperminhash

matrix:
  include:
    # stable
    - env: TARGET=x86_64-unknown-linux-gnu
      rust: stable
    - env: TARGET=x86_64-apple-darwin
      os: osx
      rust: stable

    # nightly
    - env: TARGET=x86_64-unknown-linux-gnu
      rust: nightly
    - env: TARGET=x86_64-apple-darwin
      os: osx
      rust: nightly

before_script:
  - rustc -V
  - cargo -V
  - cargo install --force cross
  - git --version
  - echo $TRAVIS_BRANCH
  - git checkout $TRAVIS_BRANCH
  - git rev-parse HEAD

script:
  - cross build --target $TARGET
  - cargo test --verbose

before_deploy:
  - bash ci/before_deploy.sh

branches:
  only:
    - master

deploy:
  provider: releases
  api_key:
    secure: ""
  file: $CRATE_NAME-$TRAVIS_TAG-$TARGET.tar.gz
  skip_cleanup: true
  on:
    repo: ocadaruma/redis-hyperminhash
    condition: $TRAVIS_RUST_VERSION = stable
    tags: true
